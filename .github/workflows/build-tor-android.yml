name: Build Tor for Android

on:
  workflow_dispatch:
  push:
    paths:
      - 'tor/**'
      - '.github/workflows/build-tor-android.yml'

jobs:
  build:
    runs-on: ubuntu-22.04

    strategy:
      fail-fast: false
      matrix:
        abi: [arm64-v8a, armeabi-v7a]

    steps:
      - uses: actions/checkout@v4

      - name: Setup NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r27c
          add-to-path: true

      - name: Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential autoconf automake libtool \
            pkg-config cmake ninja-build gettext autopoint texinfo docbook2x \
            git zlib1g-dev perl liblzma-dev wget

      - name: Env
        run: |
          API=21
          case "${{ matrix.abi }}" in
            arm64-v8a)
              HOST_TRIPLE="aarch64-linux-android"
              OPENSSL_TARGET="android-arm64"
              TLS_ALIGN=64
              ;;
            armeabi-v7a)
              HOST_TRIPLE="armv7a-linux-androideabi"
              OPENSSL_TARGET="android-arm"
              TLS_ALIGN=32
              ;;
          esac

          TOOLCHAIN="$ANDROID_NDK/toolchains/llvm/prebuilt/linux-x86_64/bin"
          BUILD_ROOT="$GITHUB_WORKSPACE/build/${{ matrix.abi }}"

          echo "API=$API" >> $GITHUB_ENV
          echo "HOST_TRIPLE=$HOST_TRIPLE" >> $GITHUB_ENV
          echo "OPENSSL_TARGET=$OPENSSL_TARGET" >> $GITHUB_ENV
          echo "TOOLCHAIN=$TOOLCHAIN" >> $GITHUB_ENV
          echo "BUILD_ROOT=$BUILD_ROOT" >> $GITHUB_ENV
          echo "TLS_ALIGN=$TLS_ALIGN" >> $GITHUB_ENV

          echo "CC=$TOOLCHAIN/${HOST_TRIPLE}${API}-clang" >> $GITHUB_ENV
          echo "CXX=$TOOLCHAIN/${HOST_TRIPLE}${API}-clang++" >> $GITHUB_ENV
          echo "AR=$TOOLCHAIN/llvm-ar" >> $GITHUB_ENV
          echo "RANLIB=$TOOLCHAIN/llvm-ranlib" >> $GITHUB_ENV
          echo "STRIP=$TOOLCHAIN/llvm-strip" >> $GITHUB_ENV

      # ===================== OpenSSL =====================
      - name: Build OpenSSL
        run: |
          mkdir -p "$BUILD_ROOT/openssl"
          cd "$BUILD_ROOT/openssl"
          git clone https://github.com/openssl/openssl.git --depth=1 --branch=openssl-3.2 src
          cd src

          export CFLAGS="-fPIC -O2 -pthread -ftls-model=initial-exec"
          export LDFLAGS="-pthread -Wl,-z,max-page-size=16384"

          ./Configure "$OPENSSL_TARGET" no-shared -D__ANDROID_API__=$API \
            --prefix="$BUILD_ROOT/openssl_install"

          make -j$(nproc)
          make install_sw

      # ===================== XZ =====================
      - name: Build xz
        run: |
          mkdir -p "$BUILD_ROOT/xz"
          cd "$BUILD_ROOT/xz"
          wget https://tukaani.org/xz/xz-5.4.5.tar.gz
          tar -xzf xz-5.4.5.tar.gz
          cd xz-5.4.5

          export CFLAGS="-fPIC -O2"
          export LDFLAGS="-Wl,-z,max-page-size=16384"

          ./configure --host="$HOST_TRIPLE" \
            --prefix="$BUILD_ROOT/xz_install" \
            --disable-shared --enable-static --disable-nls

          make -j$(nproc)
          make install

      # ===================== libevent =====================
      - name: Build libevent
        run: |
          cd "$BUILD_ROOT"
          git clone https://github.com/libevent/libevent.git --branch=release-2.1.12-stable --depth=1
          cd libevent
          ./autogen.sh

          export CFLAGS="-fPIC -O2 -pthread -ftls-model=initial-exec -I$BUILD_ROOT/openssl_install/include"
          export LDFLAGS="-pthread -Wl,-z,max-page-size=16384 -L$BUILD_ROOT/openssl_install/lib"

          ./configure --host="$HOST_TRIPLE" \
            --prefix="$BUILD_ROOT/libevent_install" \
            --disable-shared --enable-static

          make -j$(nproc)
          make install

      # ===================== zlib =====================
      - name: Build zlib
        run: |
          mkdir -p "$BUILD_ROOT/zlib"
          cd "$BUILD_ROOT/zlib"
          git clone https://github.com/madler/zlib.git --depth=1 --branch=v1.3.1
          cd zlib

          export CFLAGS="-fPIC -O2"
          export LDFLAGS="-Wl,-z,max-page-size=16384"

          ./configure --static --prefix="$BUILD_ROOT/zlib_install"
          make -j$(nproc)
          make install

      # ===================== Tor + TLS Dummy =====================
      - name: Build Tor
        run: |
          cd "$BUILD_ROOT"
          git clone https://git.torproject.org/tor.git --branch=release-0.4.8 --depth=1
          cd tor

          cat > src/lib/tor_tls_dummy.c <<EOF
          #include <stdint.h>
          static __thread volatile char tor_tls_dummy __attribute__((aligned($TLS_ALIGN))) = 0;
          void *tor_force_tls_dummy(void){ return (void*)&tor_tls_dummy; }
          __attribute__((constructor))
          static void tor_force_tls_ctor(void){ tor_force_tls_dummy(); }
          EOF

          echo "libtor_a_SOURCES += tor_tls_dummy.c" >> src/lib/Makefile.am

          ./autogen.sh

          export CFLAGS="-O2 -fPIC -pthread -ftls-model=initial-exec \
            -I$BUILD_ROOT/openssl_install/include \
            -I$BUILD_ROOT/libevent_install/include \
            -I$BUILD_ROOT/zlib_install/include \
            -I$BUILD_ROOT/xz_install/include"

          export LDFLAGS="-pthread -Wl,-z,max-page-size=16384 \
            -L$BUILD_ROOT/openssl_install/lib \
            -L$BUILD_ROOT/libevent_install/lib \
            -L$BUILD_ROOT/zlib_install/lib \
            -L$BUILD_ROOT/xz_install/lib"

          ./configure --host="$HOST_TRIPLE" \
            --prefix="$BUILD_ROOT/tor_install" \
            --enable-static-tor \
            --with-openssl-dir="$BUILD_ROOT/openssl_install" \
            --with-libevent-dir="$BUILD_ROOT/libevent_install" \
            --with-zlib-dir="$BUILD_ROOT/zlib_install" \
            --with-lzma-dir="$BUILD_ROOT/xz_install" \
            --disable-zstd --disable-asciidoc

          make -j$(nproc)
          make install

      # ===================== TLS POSTSCRIPT =====================
      - name: TLS Postmortem
        run: |
          echo "=== FINAL TLS CHECK ==="
          readelf -l "$BUILD_ROOT/tor_install/bin/tor" | grep -A2 TLS || true
          echo "=== TLS SECTIONS ==="
          readelf -S "$BUILD_ROOT/tor_install/bin/tor" | grep -E "tdata|tbss" || true
          echo "=== LOAD SEGMENTS ==="
          readelf -l "$BUILD_ROOT/tor_install/bin/tor" | grep LOAD

      # ===================== ARTIFACT =====================
      - name: Upload Tor
        uses: actions/upload-artifact@v4
        with:
          name: tor-${{ matrix.abi }}
          path: ${{ env.BUILD_ROOT }}/tor_install/bin

