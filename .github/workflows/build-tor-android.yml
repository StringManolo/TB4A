name: Build Tor for Android (ARM only)

on:
  push:
    tags: ['tor-*']
  workflow_dispatch:

env:
  TOR_VERSION: "0.4.8.21"
  OPENSSL_VERSION: "1.1.1w"
  LIBEVENT_VERSION: "2.1.12-stable"

jobs:
  build:
    strategy:
      matrix:
        arch: [arm64-v8a, armeabi-v7a]
    runs-on: ubuntu-24.04
    timeout-minutes: 45

    steps:
    - name: Check available NDK versions
      run: |
        echo "üìã Available Android NDK versions:"
        ls -la /usr/local/lib/android/sdk/ndk/ || echo "‚ùå NDK directory not found"
        echo "üîç Checking ANDROID_NDK_HOME: $ANDROID_NDK_HOME"
        echo "üîç Checking ANDROID_NDK_LATEST_HOME: $ANDROID_NDK_LATEST_HOME"

    - name: Download sources
      run: |
        echo "üì• Downloading Tor source..."
        wget -q https://dist.torproject.org/tor-${{ env.TOR_VERSION }}.tar.gz
        tar -xzf tor-${{ env.TOR_VERSION }}.tar.gz
        mv tor-${{ env.TOR_VERSION }} tor-src

        echo "üì• Downloading OpenSSL source..."
        wget -q https://www.openssl.org/source/openssl-${{ env.OPENSSL_VERSION }}.tar.gz
        tar -xzf openssl-${{ env.OPENSSL_VERSION }}.tar.gz
        mv openssl-${{ env.OPENSSL_VERSION }} openssl-src

        echo "üì• Downloading libevent source..."
        wget -q https://github.com/libevent/libevent/releases/download/release-${{ env.LIBEVENT_VERSION }}/libevent-${{ env.LIBEVENT_VERSION }}.tar.gz
        tar -xzf libevent-${{ env.LIBEVENT_VERSION }}.tar.gz
        mv libevent-${{ env.LIBEVENT_VERSION }} libevent-src

    - name: Install host dependencies
      run: |
        echo "üì¶ Installing build dependencies..."
        sudo apt-get update -qq
        sudo apt-get install -y -qq \
          autoconf \
          automake \
          libtool \
          gettext \
          pkg-config \
          make \
          clang \
          file \
          perl
        echo "‚úÖ Dependencies installed"

    - name: Setup environment for ${{ matrix.arch }}
      id: setup_env
      run: |
        # Set architecture-specific variables
        case "${{ matrix.arch }}" in
          arm64-v8a)
            HOST="aarch64-linux-android"
            TARGET_TRIPLET="aarch64-linux-android"
            API_LEVEL="21"
            ;;
          armeabi-v7a)
            HOST="armv7a-linux-androideabi"
            TARGET_TRIPLET="armv7a-linux-androideabi"
            API_LEVEL="21"
            ;;
        esac

        echo "HOST=$HOST" >> $GITHUB_ENV
        echo "TARGET_TRIPLET=$TARGET_TRIPLET" >> $GITHUB_ENV
        echo "API_LEVEL=$API_LEVEL" >> $GITHUB_ENV

        export ANDROID_NDK_HOME="${ANDROID_NDK_ROOT:-$ANDROID_NDK_LATEST_HOME}"
        if [ -z "$ANDROID_NDK_HOME" ]; then
          export ANDROID_NDK_HOME="/usr/local/lib/android/sdk/ndk/$(ls /usr/local/lib/android/sdk/ndk/ | head -1)"
        fi
        echo "ANDROID_NDK_HOME=$ANDROID_NDK_HOME" >> $GITHUB_ENV

        TOOLCHAIN_LLVM="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64"
        echo "TOOLCHAIN=$TOOLCHAIN_LLVM" >> $GITHUB_ENV

        SYSROOT="$TOOLCHAIN_LLVM/sysroot"
        INSTALL_DIR="$(pwd)/install/${{ matrix.arch }}"

        # Set compiler paths using the variables we defined in this step
        echo "CC=$TOOLCHAIN_LLVM/bin/${TARGET_TRIPLET}${API_LEVEL}-clang" >> $GITHUB_ENV
        echo "CXX=$TOOLCHAIN_LLVM/bin/${TARGET_TRIPLET}${API_LEVEL}-clang++" >> $GITHUB_ENV
        echo "TARGET_FLAGS=-target ${TARGET_TRIPLET}${API_LEVEL} --sysroot=$SYSROOT" >> $GITHUB_ENV

        echo "AR=$TOOLCHAIN_LLVM/bin/llvm-ar" >> $GITHUB_ENV
        echo "RANLIB=$TOOLCHAIN_LLVM/bin/llvm-ranlib" >> $GITHUB_ENV
        echo "STRIP=$TOOLCHAIN_LLVM/bin/llvm-strip" >> $GITHUB_ENV

        echo "PATH=$TOOLCHAIN_LLVM/bin:$PATH" >> $GITHUB_ENV
        echo "INSTALL_DIR=$INSTALL_DIR" >> $GITHUB_ENV

        echo "CPPFLAGS=-I$INSTALL_DIR/include" >> $GITHUB_ENV
        echo "LDFLAGS=-L$INSTALL_DIR/lib" >> $GITHUB_ENV
        echo "CFLAGS=$TARGET_FLAGS" >> $GITHUB_ENV
        echo "CXXFLAGS=$TARGET_FLAGS" >> $GITHUB_ENV

    - name: Configure and build OpenSSL for ${{ matrix.arch }}
      run: |
        echo "üèóÔ∏è Building OpenSSL for ${{ matrix.arch }}..."

        cd openssl-src

        case "${{ matrix.arch }}" in
          arm64-v8a)
            TARGET_CONFIG="android-arm64"
            ;;
          armeabi-v7a)
            TARGET_CONFIG="android-armeabi"
            ;;
        esac

        # Use the environment variables that are now properly set
        export CC="${{ env.CC }}"
        export CXX="${{ env.CXX }}"
        export AR="${{ env.AR }}"
        export RANLIB="${{ env.RANLIB }}"
        export STRIP="${{ env.STRIP }}"
        export CFLAGS="${{ env.CFLAGS }}"
        export CXXFLAGS="${{ env.CXXFLAGS }}"
        export LDFLAGS="${{ env.LDFLAGS }}"
        export CPPFLAGS="${{ env.CPPFLAGS }}"

        ./Configure $TARGET_CONFIG \
          no-shared \
          no-weak-ssl-ciphers \
          no-asm \
          --prefix=${{ env.INSTALL_DIR }} \
          -D__ANDROID_API__=${{ env.API_LEVEL }} \
          -fPIC

        echo "üî® Compiling and installing OpenSSL..."
        make -j2
        make install_sw

        echo "‚úÖ OpenSSL compiled and installed"

    - name: Configure and build libevent for ${{ matrix.arch }}
      run: |
        echo "üèóÔ∏è Building libevent for ${{ matrix.arch }}..."

        cd libevent-src

        # Export all the environment variables
        export CC="${{ env.CC }}"
        export CXX="${{ env.CXX }}"
        export AR="${{ env.AR }}"
        export RANLIB="${{ env.RANLIB }}"
        export STRIP="${{ env.STRIP }}"
        export CFLAGS="${{ env.CFLAGS }}"
        export CXXFLAGS="${{ env.CXXFLAGS }}"
        export LDFLAGS="${{ env.LDFLAGS }}"
        export CPPFLAGS="${{ env.CPPFLAGS }}"

        chmod +x ./configure
        ./configure \
          --host=${{ env.HOST }} \
          --prefix=${{ env.INSTALL_DIR }} \
          --disable-shared \
          --enable-static \
          --disable-samples \
          --enable-openssl \
          --with-openssl-dir=${{ env.INSTALL_DIR }}

        echo "üî® Compiling and installing libevent..."
        make -j2
        make install

        echo "‚úÖ libevent compiled and installed"

    - name: Configure and build Tor for ${{ matrix.arch }}
      run: |
        echo "üèóÔ∏è Building Tor for ${{ matrix.arch }}..."

        cd tor-src

        # Export all the environment variables
        export CC="${{ env.CC }}"
        export CXX="${{ env.CXX }}"
        export AR="${{ env.AR }}"
        export RANLIB="${{ env.RANLIB }}"
        export STRIP="${{ env.STRIP }}"
        export CFLAGS="${{ env.CFLAGS }}"
        export CXXFLAGS="${{ env.CXXFLAGS }}"
        export LDFLAGS="${{ env.LDFLAGS }}"
        export CPPFLAGS="${{ env.CPPFLAGS }}"

        chmod +x ./configure
        ./configure \
          --host=${{ env.HOST }} \
          --enable-static \
          --disable-asciidoc \
          --disable-manpage \
          --disable-html-manual \
          --disable-system-torrc \
          --disable-unittests \
          --enable-lzma=no \
          --enable-zstd=no \
          --enable-seccomp=no \
          --enable-libscrypt=no \
          --enable-tool-name-check=no \
          --with-libevent-dir=${{ env.INSTALL_DIR }} \
          --with-openssl-dir=${{ env.INSTALL_DIR }} \
          --prefix=${{ env.INSTALL_DIR }}

        echo "üî® Compiling Tor..."
        make -j2

        echo "‚úÖ Tor built successfully for ${{ matrix.arch }}"

        echo "üîç Checking resulting binary..."
        ls -la ${{ env.INSTALL_DIR }}/bin/tor
        ${{ env.STRIP }} ${{ env.INSTALL_DIR }}/bin/tor

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: tor-android-${{ matrix.arch }}-${{ env.TOR_VERSION }}
        path: install/${{ matrix.arch }}/bin/tor
