name: Build Tor for Android

on:
  workflow_dispatch:
  push:
    paths:
      - 'tor/**'
      - '.github/workflows/build-tor-android.yml'

jobs:
  build:
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        abi: [arm64-v8a, armeabi-v7a]

    steps:
      - uses: actions/checkout@v4

      - name: Setup NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r27c
          add-to-path: true

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential autoconf automake libtool pkg-config cmake ninja-build gettext autopoint texinfo docbook2x git zlib1g-dev perl liblzma-dev wget

      - name: Set Environment
        run: |
          export API=21
          case "${{ matrix.abi }}" in
            arm64-v8a)
              HOST=aarch64-linux-android
              OPENSSL_TARGET=android-arm64
              TLS_ALIGN=64
              ;;
            armeabi-v7a)
              HOST=armv7a-linux-androideabi
              OPENSSL_TARGET=android-arm
              TLS_ALIGN=32
              ;;
          esac
          TOOLCHAIN=$ANDROID_NDK/toolchains/llvm/prebuilt/linux-x86_64/bin
          BUILD=$GITHUB_WORKSPACE/build/${{ matrix.abi }}

          echo "API=$API" >> $GITHUB_ENV
          echo "HOST=$HOST" >> $GITHUB_ENV
          echo "OPENSSL_TARGET=$OPENSSL_TARGET" >> $GITHUB_ENV
          echo "TOOLCHAIN=$TOOLCHAIN" >> $GITHUB_ENV
          echo "BUILD=$BUILD" >> $GITHUB_ENV
          echo "TLS_ALIGN=$TLS_ALIGN" >> $GITHUB_ENV

          echo "CC=$TOOLCHAIN/${HOST}${API}-clang" >> $GITHUB_ENV
          echo "CXX=$TOOLCHAIN/${HOST}${API}-clang++" >> $GITHUB_ENV
          echo "AR=$TOOLCHAIN/llvm-ar" >> $GITHUB_ENV
          echo "RANLIB=$TOOLCHAIN/llvm-ranlib" >> $GITHUB_ENV
          echo "STRIP=$TOOLCHAIN/llvm-strip" >> $GITHUB_ENV

      - name: Build OpenSSL
        run: |
          mkdir -p $BUILD/openssl && cd $BUILD/openssl
          git clone --depth=1 --branch=openssl-3.2 https://github.com/openssl/openssl.git src
          cd src
          export CC=$TOOLCHAIN/${HOST}${API}-clang
          export CXX=$TOOLCHAIN/${HOST}${API}-clang++
          export AR=$TOOLCHAIN/llvm-ar
          export RANLIB=$TOOLCHAIN/llvm-ranlib
          export STRIP=$TOOLCHAIN/llvm-strip
          export CFLAGS="-fPIC -O2 -ftls-model=global-dynamic -Wl,-z,max-page-size=16384"
          export LDFLAGS="-fPIC -pie -ldl -Wl,-z,max-page-size=16384"
          ./Configure $OPENSSL_TARGET no-shared no-tests --prefix=$BUILD/openssl_install -D__ANDROID_API__=$API
          make -j$(nproc)
          make install_sw

      - name: Build xz
        run: |
          mkdir -p $BUILD/xz && cd $BUILD/xz
          wget https://tukaani.org/xz/xz-5.4.5.tar.gz
          tar -xzf xz-5.4.5.tar.gz
          cd xz-5.4.5
          export CC=$TOOLCHAIN/${HOST}${API}-clang
          export AR=$TOOLCHAIN/llvm-ar
          export RANLIB=$TOOLCHAIN/llvm-ranlib
          export CFLAGS="-fPIC -O2 -ftls-model=global-dynamic -Wl,-z,max-page-size=16384"
          export LDFLAGS="-fPIC -pie -Wl,-z,max-page-size=16384"
          ./configure --host=$HOST --prefix=$BUILD/xz_install --disable-shared --enable-static --disable-xz --disable-xzdec --disable-lzmadec --disable-lzmainfo --disable-scripts --disable-nls
          make -j$(nproc)
          make install

      - name: Build zlib
        run: |
          mkdir -p $BUILD/zlib && cd $BUILD/zlib
          git clone --depth=1 --branch=v1.3.1 https://github.com/madler/zlib.git src
          cd src
          export CC=$TOOLCHAIN/${HOST}${API}-clang
          export AR=$TOOLCHAIN/llvm-ar
          export RANLIB=$TOOLCHAIN/llvm-ranlib
          export CFLAGS="-fPIC -O2 -ftls-model=global-dynamic -Wl,-z,max-page-size=16384"
          ./configure --static --prefix=$BUILD/zlib_install
          make -j$(nproc)
          make install

      - name: Build libevent
        run: |
          mkdir -p $BUILD/libevent && cd $BUILD/libevent
          git clone --depth=1 --branch=release-2.1.12-stable https://github.com/libevent/libevent.git src
          cd src
          ./autogen.sh
          export CC=$TOOLCHAIN/${HOST}${API}-clang
          export AR=$TOOLCHAIN/llvm-ar
          export RANLIB=$TOOLCHAIN/llvm-ranlib
          export CFLAGS="-fPIC -O2 -ftls-model=global-dynamic -I$BUILD/openssl_install/include -I$BUILD/zlib_install/include -I$BUILD/xz_install/include -Wl,-z,max-page-size=16384"
          export LDFLAGS="-fPIC -pie -L$BUILD/openssl_install/lib -L$BUILD/zlib_install/lib -L$BUILD/xz_install/lib -Wl,-z,max-page-size=16384 -ldl"
          ./configure --host=$HOST --prefix=$BUILD/libevent_install --disable-shared --enable-static
          make -j$(nproc)
          make install

      - name: Build Tor
        run: |
          mkdir -p $BUILD/tor && cd $BUILD/tor
          git clone --depth=1 --branch=release-0.4.8 https://git.torproject.org/tor.git src
          cd src
          ./autogen.sh
          export CC=$TOOLCHAIN/${HOST}${API}-clang
          export CXX=$TOOLCHAIN/${HOST}${API}-clang++
          export AR=$TOOLCHAIN/llvm-ar
          export RANLIB=$TOOLCHAIN/llvm-ranlib
          export STRIP=$TOOLCHAIN/llvm-strip
          export CFLAGS="-fPIC -O2 -ftls-model=global-dynamic -I$BUILD/openssl_install/include -I$BUILD/libevent_install/include -I$BUILD/zlib_install/include -I$BUILD/xz_install/include -Wl,-z,max-page-size=16384"
          export LDFLAGS="-fPIC -pie -L$BUILD/openssl_install/lib -L$BUILD/libevent_install/lib -L$BUILD/zlib_install/lib -L$BUILD/xz_install/lib -ldl -Wl,-z,max-page-size=16384"
          ./configure --host=$HOST --prefix=$BUILD/tor_install --disable-asciidoc --enable-static-tor --with-openssl-dir=$BUILD/openssl_install --with-libevent-dir=$BUILD/libevent_install --with-zlib-dir=$BUILD/zlib_install --with-lzma-dir=$BUILD/xz_install --disable-tool-name-check --disable-zstd
          make -j$(nproc)
          make install

      - name: Verify TLS Alignment (Detailed)
        run: |
          echo "=== Checking OpenSSL TLS ==="
          for f in $BUILD/openssl_install/lib/*.a; do
            echo "File: $f"
            readelf -l $f | grep TLS || echo "No TLS segment found"
            readelf -S $f | grep tls || echo "No TLS section found"
          done

          echo "=== Checking libevent TLS ==="
          for f in $BUILD/libevent_install/lib/*.a; do
            echo "File: $f"
            readelf -l $f | grep TLS || echo "No TLS segment found"
            readelf -S $f | grep tls || echo "No TLS section found"
          done

          echo "=== Checking zlib TLS ==="
          for f in $BUILD/zlib_install/lib/*.a; do
            echo "File: $f"
            readelf -l $f | grep TLS || echo "No TLS segment found"
            readelf -S $f | grep tls || echo "No TLS section found"
          done

          echo "=== Checking xz TLS ==="
          for f in $BUILD/xz_install/lib/*.a; do
            echo "File: $f"
            readelf -l $f | grep TLS || echo "No TLS segment found"
            readelf -S $f | grep tls || echo "No TLS section found"
          done

          echo "=== Checking Tor TLS ==="
          TOR_BIN=$BUILD/tor_install/bin/tor
          file $TOR_BIN
          readelf -l $TOR_BIN | grep TLS || echo "No TLS segment found"
          readelf -S $TOR_BIN | grep tls || echo "No TLS section found"

          echo "=== TLS Alignment Summary ==="
          readelf -l $TOR_BIN | grep LOAD | head -5

      - name: Upload Tor
        uses: actions/upload-artifact@v4
        with:
          name: tor-${{ matrix.abi }}
          path: $BUILD/tor_install

