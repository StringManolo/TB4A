name: Build Tor for Android

on:
  workflow_dispatch:
  push:
    paths:
      - 'tor/**'
      - '.github/workflows/build-tor-android.yml'

jobs:
  build:
    runs-on: ubuntu-22.04

    strategy:
      fail-fast: false
      matrix:
        abi: [arm64-v8a, armeabi-v7a]

    steps:
      - uses: actions/checkout@v4

      - name: Setup NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r27c
          add-to-path: true

      - name: Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential autoconf automake libtool pkg-config cmake ninja-build gettext autopoint texinfo docbook2x git zlib1g-dev perl liblzma-dev

      - name: Env
        run: |
          export API=21
          case "${{ matrix.abi }}" in
            arm64-v8a)
              HOST_TRIPLE="aarch64-linux-android"
              OPENSSL_TARGET="android-arm64"
              TLS_ALIGN=64
              ;;
            armeabi-v7a)
              HOST_TRIPLE="armv7a-linux-androideabi"
              OPENSSL_TARGET="android-arm"
              TLS_ALIGN=32
              ;;
          esac

          TOOLCHAIN="$ANDROID_NDK/toolchains/llvm/prebuilt/linux-x86_64/bin"
          BUILD_ROOT="$GITHUB_WORKSPACE/build/${{ matrix.abi }}"

          echo "API=$API" >> $GITHUB_ENV
          echo "HOST_TRIPLE=$HOST_TRIPLE" >> $GITHUB_ENV
          echo "OPENSSL_TARGET=$OPENSSL_TARGET" >> $GITHUB_ENV
          echo "TOOLCHAIN=$TOOLCHAIN" >> $GITHUB_ENV
          echo "BUILD_ROOT=$BUILD_ROOT" >> $GITHUB_ENV
          echo "TLS_ALIGN=$TLS_ALIGN" >> $GITHUB_ENV

          echo "CC=$TOOLCHAIN/${HOST_TRIPLE}${API}-clang" >> $GITHUB_ENV
          echo "CXX=$TOOLCHAIN/${HOST_TRIPLE}${API}-clang++" >> $GITHUB_ENV
          echo "AR=$TOOLCHAIN/llvm-ar" >> $GITHUB_ENV
          echo "RANLIB=$TOOLCHAIN/llvm-ranlib" >> $GITHUB_ENV
          echo "STRIP=$TOOLCHAIN/llvm-strip" >> $GITHUB_ENV

      - name: Build OpenSSL
        env:
          PATH: ${{ env.TOOLCHAIN }}:/usr/bin:/bin
        run: |
          mkdir -p "$BUILD_ROOT/openssl_build"
          cd "$BUILD_ROOT/openssl_build"
          git clone https://github.com/openssl/openssl.git --depth=1 --branch=openssl-3.2 openssl_src
          cd openssl_src

          export CC="$TOOLCHAIN/${HOST_TRIPLE}${API}-clang"
          export CXX="$TOOLCHAIN/${HOST_TRIPLE}${API}-clang++"
          export AR="$TOOLCHAIN/llvm-ar"
          export RANLIB="$TOOLCHAIN/llvm-ranlib"
          export STRIP="$TOOLCHAIN/llvm-strip"
          
          export CFLAGS="-fPIC -O2"
          export LDFLAGS="-fPIC -pie"

          ./Configure "$OPENSSL_TARGET" no-shared no-tests -D__ANDROID_API__=$API --prefix="$BUILD_ROOT/openssl_install"
          make -j$(nproc)
          make install_sw

      - name: Build xz (LZMA)
        env:
          PATH: ${{ env.TOOLCHAIN }}:/usr/bin:/bin
        run: |
          mkdir -p "$BUILD_ROOT/xz_build"
          cd "$BUILD_ROOT/xz_build"
          wget https://tukaani.org/xz/xz-5.4.5.tar.gz
          tar -xzf xz-5.4.5.tar.gz
          cd xz-5.4.5

          export CC="$TOOLCHAIN/${HOST_TRIPLE}${API}-clang"
          export CXX="$TOOLCHAIN/${HOST_TRIPLE}${API}-clang++"
          export AR="$TOOLCHAIN/llvm-ar"
          export RANLIB="$TOOLCHAIN/llvm-ranlib"
          export STRIP="$TOOLCHAIN/llvm-strip"

          ./configure \
            --host="$HOST_TRIPLE" \
            --prefix="$BUILD_ROOT/xz_install" \
            --disable-shared \
            --enable-static \
            --disable-xz \
            --disable-xzdec \
            --disable-lzmadec \
            --disable-lzmainfo \
            --disable-scripts \
            --disable-nls

          make -j$(nproc)
          make install

      - name: Build libevent
        run: |
          cd "$BUILD_ROOT"
          git clone https://github.com/libevent/libevent.git --depth=1 --branch=release-2.1.12-stable libevent
          cd libevent

          ./autogen.sh
          
          export CFLAGS="-fPIC -O2 -I$BUILD_ROOT/openssl_install/include"
          export LDFLAGS="-fPIC -pie -L$BUILD_ROOT/openssl_install/lib"
          
          ./configure \
            --host="$HOST_TRIPLE" \
            --prefix="$BUILD_ROOT/libevent_install" \
            --disable-shared \
            --enable-static

          make -j$(nproc)
          make install

      - name: Build zlib
        env:
          PATH: ${{ env.TOOLCHAIN }}:/usr/bin:/bin
        run: |
          mkdir -p "$BUILD_ROOT/zlib_build"
          cd "$BUILD_ROOT/zlib_build"
          git clone https://github.com/madler/zlib.git --depth=1 --branch=v1.3.1 zlib_src
          cd zlib_src

          export CC="$TOOLCHAIN/${HOST_TRIPLE}${API}-clang"
          export CXX="$TOOLCHAIN/${HOST_TRIPLE}${API}-clang++"
          export AR="$TOOLCHAIN/llvm-ar"
          export RANLIB="$TOOLCHAIN/llvm-ranlib"
          export STRIP="$TOOLCHAIN/llvm-strip"

          ./configure --static --prefix="$BUILD_ROOT/zlib_install"
          make -j$(nproc)
          make install

      - name: Build Tor with custom linker script for TLS alignment
        env:
          PATH: ${{ env.TOOLCHAIN }}:/usr/bin:/bin
        run: |
          cd "$BUILD_ROOT"
          git clone https://git.torproject.org/tor.git --depth=1 --branch=release-0.4.8 tor
          cd tor

          ./autogen.sh
          
          # Create custom linker script for TLS alignment
          case "${{ matrix.abi }}" in
            arm64-v8a)
              ALIGN=64
              ;;
            armeabi-v7a)
              ALIGN=32
              ;;
          esac
          
          cat > custom_linker.ld << EOF
          /* Custom linker script to enforce TLS alignment for Android */
          PHDRS
          {
            headers PT_PHDR PHDRS ;
            text PT_LOAD FILEHDR PHDRS ;
            data PT_LOAD ;
            tls PT_TLS ;
          }
          
          SECTIONS
          {
            .text : { *(.text*) } :text
            .data : { *(.data*) } :data
            .tdata : { 
              . = ALIGN($ALIGN);
              *(.tdata .tdata.* .gnu.linkonce.td.*)
            } :tls
            .tbss : { 
              . = ALIGN($ALIGN);
              *(.tbss .tbss.* .gnu.linkonce.tb.*) *(.tcommon)
            } :tls
          }
          EOF

          export CFLAGS="-fPIC -O2 -I$BUILD_ROOT/openssl_install/include -I$BUILD_ROOT/libevent_install/include -I$BUILD_ROOT/zlib_install/include -I$BUILD_ROOT/xz_install/include"
          export LDFLAGS="-fPIC -pie -L$BUILD_ROOT/openssl_install/lib -L$BUILD_ROOT/libevent_install/lib -L$BUILD_ROOT/zlib_install/lib -L$BUILD_ROOT/xz_install/lib -ldl -Wl,-T,custom_linker.ld -Wl,-z,max-page-size=0x10000 -Wl,-z,common-page-size=0x10000"

          ./configure \
            --host="$HOST_TRIPLE" \
            --prefix="$BUILD_ROOT/tor_install" \
            --disable-asciidoc \
            --enable-static-tor \
            --with-openssl-dir="$BUILD_ROOT/openssl_install" \
            --with-libevent-dir="$BUILD_ROOT/libevent_install" \
            --with-zlib-dir="$BUILD_ROOT/zlib_install" \
            --with-lzma-dir="$BUILD_ROOT/xz_install" \
            --disable-tool-name-check \
            --disable-zstd

          make -j$(nproc)
          make install

      - name: Verify TLS alignment
        run: |
          cd "$BUILD_ROOT/tor_install/bin"
          echo "=== Binary info ==="
          file tor
          echo "=== TLS segment details ==="
          readelf -l tor | grep -A10 TLS
          echo "=== Checking alignment ==="
          readelf -l tor | grep -E "(LOAD|TLS)" || true
          
          # Test if the binary runs (in a simple way)
          echo "=== Testing binary ==="
          ./tor --version || echo "Version check failed, but continuing..."

      - name: Create deployment package
        run: |
          cd "$BUILD_ROOT"
          
          # Create proper directory structure
          mkdir -p tor_package/{bin,etc/tor,share/tor}
          
          # Copy binaries
          cp tor_install/bin/* tor_package/bin/
          
          # Copy configuration
          cp tor_install/etc/tor/torrc.sample tor_package/etc/tor/
          
          # Copy geoip data
          cp -r tor_install/share/tor/* tor_package/share/tor/
          
          # Create README
          cat > tor_package/README.txt << EOF
          Tor for Android (${{ matrix.abi }})
          Built with TLS alignment fix for Android Bionic
          
          Files:
          - bin/tor: Main Tor executable
          - bin/tor-resolve: DNS resolution tool
          - bin/torify: SOCKS wrapper
          - etc/tor/torrc.sample: Sample configuration
          - share/tor/geoip: IPv4 geolocation database
          - share/tor/geoip6: IPv6 geolocation database
          
          Usage on Android:
          ./bin/tor -f etc/tor/torrc
          EOF
          
          # Create zip package
          cd tor_package
          zip -r "../tor-${{ matrix.abi }}-aligned.zip" .

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tor-${{ matrix.abi }}-tls-fixed
          path: |
            ${{ env.BUILD_ROOT }}/tor_install
            ${{ env.BUILD_ROOT }}/tor-${{ matrix.abi }}-aligned.zip
