name: Build Tor for Android (ARM only)

on:
  push:
    tags: ['tor-*']
  workflow_dispatch:

env:
  TOR_VERSION: "0.4.8.21"
  NDK_VERSION: "r27d"

jobs:
  build:
    strategy:
      matrix:
        arch: [arm64-v8a, armeabi-v7a]
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout Tor source
      uses: actions/checkout@v4
      with:
        repository: torproject/tor
        ref: "tor-${{ env.TOR_VERSION }}"

    - name: Setup Android NDK
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: ${{ env.NDK_VERSION }}
      id: ndk

    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          autoconf \
          automake \
          libtool \
          gettext \
          pkg-config \
          make \
          clang \
          file

    - name: Configure and build for ${{ matrix.arch }}
      run: |
        chmod +x ./autogen.sh
        ./autogen.sh

        case "${{ matrix.arch }}" in
          arm64-v8a)
            export HOST="aarch64-linux-android"
            export API_LEVEL="21"
            ;;
          armeabi-v7a)
            export HOST="armv7a-linux-androideabi"
            export API_LEVEL="16"
            ;;
        esac

        export TOOLCHAIN=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64
        export CC="$TOOLCHAIN/bin/${HOST}${API_LEVEL}-clang"
        export CXX="$TOOLCHAIN/bin/${HOST}${API_LEVEL}-clang++"
        export AR="$TOOLCHAIN/bin/llvm-ar"
        export RANLIB="$TOOLCHAIN/bin/llvm-ranlib"
        export STRIP="$TOOLCHAIN/bin/llvm-strip"
        export PATH="$TOOLCHAIN/bin:$PATH"

        echo "Building Tor for ${{ matrix.arch }}..."
        echo "NDK path: $ANDROID_NDK_HOME"
        echo "Toolchain: $TOOLCHAIN"
        echo "Compiler: $CC"

        ./configure \
          --host="$HOST" \
          --enable-static-libevent \
          --disable-asciidoc \
          --disable-manpage \
          --disable-html-manual \
          --disable-system-torrc \
          --disable-unittests

        make -j$(nproc)
        echo "Build completed for ${{ matrix.arch }}"

    - name: Verify binary
      run: |
        echo "Verifying Tor binary..."
        file src/app/tor
        ./src/app/tor --version || echo "Version check failed but continuing"

    - name: Prepare artifacts
      run: |
        mkdir -p artifacts/${{ matrix.arch }}
        cp src/app/tor artifacts/${{ matrix.arch }}/
        cd artifacts/${{ matrix.arch }}
        sha256sum tor > tor.sha256
        echo "Tor ${{ env.TOR_VERSION }} for ${{ matrix.arch }}" > README.txt

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: tor-${{ matrix.arch }}-${{ env.TOR_VERSION }}
        path: artifacts/${{ matrix.arch }}/

  create-release:
    needs: build
    runs-on: ubuntu-24.04
    if: startsWith(github.ref, 'refs/tags/tor-')
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: downloaded-artifacts

    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name }}
        release_name: Tor ${{ env.TOR_VERSION }} for Android
        body: |
          Tor ${{ env.TOR_VERSION }} compiled for Android
          
          Architectures included:
          - arm64-v8a (modern devices)
          - armeabi-v7a (legacy devices)
          
          Built with Android NDK ${{ env.NDK_VERSION }}
        draft: false
        prerelease: false

    - name: Upload ARM64 Binary
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: downloaded-artifacts/tor-arm64-v8a-${{ env.TOR_VERSION }}/tor
        asset_name: tor-android-arm64-v8a
        asset_content_type: application/octet-stream

    - name: Upload ARMv7 Binary
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: downloaded-artifacts/tor-armeabi-v7a-${{ env.TOR_VERSION }}/tor
        asset_name: tor-android-armeabi-v7a
        asset_content_type: application/octet-stream
