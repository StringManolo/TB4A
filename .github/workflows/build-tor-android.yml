name: Build Tor for Android (ARM only)

on:
  push:
    tags: ['tor-*']
  workflow_dispatch:

env:
  TOR_VERSION: "0.4.8.21"  # Última versión estable de Tor
  NDK_VERSION: "r27d"       # Última versión estable del NDK

jobs:
  build:
    strategy:
      matrix:
        arch: [arm64-v8a, armeabi-v7a]
    runs-on: ubuntu-24.04
    
    steps:
    - name: Checkout Tor source
      uses: actions/checkout@v4
      with:
        repository: torproject/tor
        ref: "tor-${{ env.TOR_VERSION }}"
        
    - name: Setup Android NDK
      uses: android-actions/setup-android-ndk@v2
      with:
        ndk-version: ${{ env.NDK_VERSION }}
        
    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          autoconf \
          automake \
          libtool \
          gettext \
          pkg-config \
          make \
          clang \
          file
        echo "=== Versiones instaladas ==="
        autoconf --version | head -1
        automake --version | head -1
        libtool --version | head -1
        clang --version | head -1
        
    - name: Configure and build for ${{ matrix.arch }}
      run: |
        chmod +x ./autogen.sh
        ./autogen.sh
        
        # Configurar para arquitectura específica
        case "${{ matrix.arch }}" in
          arm64-v8a)
            export HOST="aarch64-linux-android"
            export API_LEVEL="21"
            ;;
          armeabi-v7a)
            export HOST="armv7a-linux-androideabi" 
            export API_LEVEL="16"
            ;;
        esac
        
        export TOOLCHAIN=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64
        export CC="$TOOLCHAIN/bin/${HOST}${API_LEVEL}-clang"
        export CXX="$TOOLCHAIN/bin/${HOST}${API_LEVEL}-clang++"
        export AR="$TOOLCHAIN/bin/llvm-ar"
        export RANLIB="$TOOLCHAIN/bin/llvm-ranlib"
        export STRIP="$TOOLCHAIN/bin/llvm-strip"
        export PATH="$TOOLCHAIN/bin:$PATH"
        
        echo "=== Configuración de compilación ==="
        echo "Arquitectura: ${{ matrix.arch }}"
        echo "Tor version: ${{ env.TOR_VERSION }}"
        echo "NDK version: ${{ env.NDK_VERSION }}"
        echo "Host: $HOST"
        echo "API Level: $API_LEVEL"
        echo "Compiler: $CC"
        echo "Toolchain: $TOOLCHAIN"
        
        ./configure \
          --host="$HOST" \
          --enable-static-libevent \
          --disable-asciidoc \
          --disable-manpage \
          --disable-html-manual \
          --disable-system-torrc \
          --disable-unittests
        
        echo "=== Iniciando compilación ==="
        make -j$(nproc)
        echo "✅ Build completado exitosamente"
        
    - name: Verify binary
      run: |
        echo "=== Verificando binario ==="
        file src/app/tor
        echo "=== Información ELF ==="
        $TOOLCHAIN/bin/llvm-readelf -h src/app/tor || echo "⚠️  No se pudo leer ELF header, pero continuamos..."
        echo "=== Versión de Tor ==="
        ./src/app/tor --version || echo "⚠️  No se pudo verificar versión, pero continuamos..."
        
    - name: Prepare artifacts
      run: |
        mkdir -p artifacts/${{ matrix.arch }}
        cp src/app/tor artifacts/${{ matrix.arch }}/
        cp src/app/tor artifacts/${{ matrix.arch }}/tor-${{ env.TOR_VERSION }}-${{ matrix.arch }}
        
        # Crear checksums
        cd artifacts/${{ matrix.arch }}
        sha256sum tor > tor.sha256
        sha256sum tor-${{ env.TOR_VERSION }}-${{ matrix.arch }} > tor-${{ env.TOR_VERSION }}-${{ matrix.arch }}.sha256
        
        cat > README.txt << EOF
Tor ${{ env.TOR_VERSION }} for ${{ matrix.arch }}
        
Built on: $(date -u)
GitHub Run ID: $GITHUB_RUN_ID
NDK Version: ${{ env.NDK_VERSION }}
Architecture: ${{ matrix.arch }}
        
Usage: Copy to app/src/main/jniLibs/${{ matrix.arch }}/tor
EOF
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: tor-${{ matrix.arch }}-${{ env.TOR_VERSION }}
        path: artifacts/${{ matrix.arch }}/
        retention-days: 90
        
    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/tor-')
      uses: softprops/action-gh-release@v2
      with:
        files: |
          artifacts/arm64-v8a/tor
          artifacts/arm64-v8a/tor.sha256
          artifacts/armeabi-v7a/tor
          artifacts/armeabi-v7a/tor.sha256
        body: |
          # Tor ${{ env.TOR_VERSION }} for Android
          
          ## Supported Architectures:
          - **arm64-v8a**: Modern devices (2015+)
          - **armeabi-v7a**: Legacy devices (2012-2015)
          
          ## Verification
          ```bash
          # Verify checksum
          sha256sum -c tor.sha256
          
          # Verify Android binary
          file tor
          ```
          
          ## Build Details
          - **Tor version**: ${{ env.TOR_VERSION }}
          - **Android NDK**: ${{ env.NDK_VERSION }}
          - **Build date**: $(date -u -Iseconds)
          - **Supported ABIs**: arm64-v8a, armeabi-v7a
          
          ## Usage
          Copy binaries to your Android project:
          ```
          app/src/main/jniLibs/
          ├── arm64-v8a/tor
          └── armeabi-v7a/tor
          ```
