name: Build Tor for Android (ARM only)

on:
  push:
    tags: ['tor-*']
  workflow_dispatch:

env:
  TOR_VERSION: "0.4.8.21"

jobs:
  build:
    strategy:
      matrix:
        arch: [arm64-v8a, armeabi-v7a]
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: Check available NDK versions
      run: |
        echo "üìã Available Android NDK versions:"
        ls -la /usr/local/lib/android/sdk/ndk/ || echo "‚ùå NDK directory not found"
        echo "üîç Checking ANDROID_NDK_HOME: $ANDROID_NDK_HOME"
        echo "üîç Checking ANDROID_NDK_LATEST_HOME: $ANDROID_NDK_LATEST_HOME"

    - name: Check Tor tag exists
      run: |
        echo "‚úÖ Checking if tag tor-${{ env.TOR_VERSION }} exists..."
        git ls-remote --tags https://git.torproject.org/tor.git | grep "tor-${{ env.TOR_VERSION }}" || echo "‚ö†Ô∏è Tag not found, but continuing with tarball..."

    - name: Download Tor source
      run: |
        echo "üì• Downloading Tor source..."
        wget -q https://dist.torproject.org/tor-${{ env.TOR_VERSION }}.tar.gz
        tar -xzf tor-${{ env.TOR_VERSION }}.tar.gz
        mv tor-${{ env.TOR_VERSION }} tor-src
        echo "üìÅ Source files:"
        ls -la tor-src/

    - name: Install build dependencies
      run: |
        echo "üì¶ Installing build dependencies..."
        sudo apt-get update -qq
        sudo apt-get install -y -qq \
          autoconf \
          automake \
          libtool \
          gettext \
          pkg-config \
          make \
          clang \
          file
        echo "‚úÖ Dependencies installed"

    - name: Configure and build for ${{ matrix.arch }}
      run: |
        cd tor-src
        
        echo "üîß Running autogen..."
        chmod +x ./autogen.sh
        ./autogen.sh || echo "‚ö†Ô∏è autogen.sh might have warnings but continuing..."

        case "${{ matrix.arch }}" in
          arm64-v8a)
            export HOST="aarch64-linux-android"
            export API_LEVEL="21"
            ;;
          armeabi-v7a)
            export HOST="armv7a-linux-androideabi"
            export API_LEVEL="16"
            ;;
        esac

        # Usar NDK preinstalado de GitHub Actions
        export ANDROID_NDK_HOME="${ANDROID_NDK_ROOT:-$ANDROID_NDK_LATEST_HOME}"
        if [ -z "$ANDROID_NDK_HOME" ]; then
          # Fallback: buscar NDK en la ubicaci√≥n est√°ndar
          export ANDROID_NDK_HOME="/usr/local/lib/android/sdk/ndk/$(ls /usr/local/lib/android/sdk/ndk/ | head -1)"
        fi
        
        export TOOLCHAIN="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64"
        export CC="$TOOLCHAIN/bin/${HOST}${API_LEVEL}-clang"
        export CXX="$TOOLCHAIN/bin/${HOST}${API_LEVEL}-clang++"
        export AR="$TOOLCHAIN/bin/llvm-ar"
        export RANLIB="$TOOLCHAIN/bin/llvm-ranlib"
        export STRIP="$TOOLCHAIN/bin/llvm-strip"
        export PATH="$TOOLCHAIN/bin:$PATH"

        echo "üèóÔ∏è Building Tor for ${{ matrix.arch }}..."
        echo "üìã Build details:"
        echo "  - Host: $HOST"
        echo "  - API Level: $API_LEVEL"
        echo "  - CC: $CC"
        echo "  - NDK: $ANDROID_NDK_HOME"
        echo "  - Toolchain: $TOOLCHAIN"

        # Verificar que el compilador existe
        if [ ! -f "$CC" ]; then
          echo "‚ùå Compiler not found: $CC"
          echo "üìÅ Toolchain contents:"
          ls -la "$TOOLCHAIN/bin/" || echo "Toolchain directory not found"
          exit 1
        fi

        echo "‚öôÔ∏è Configuring Tor..."
        ./configure \
          --host="$HOST" \
          --enable-static-libevent \
          --disable-asciidoc \
          --disable-manpage \
          --disable-html-manual \
          --disable-system-torrc \
          --disable-unittests \
          --enable-lzma=no \
          --enable-zstd=no \
          --enable-seccomp=no \
          --enable-libscrypt=no \
          --enable-tool-name-check=no
        
        echo "üî® Compiling Tor..."
        make -j2
        
        echo "‚úÖ Build completed for ${{ matrix.arch }}"

    - name: Verify binary
      run: |
        cd tor-src
        echo "üîç Verifying Tor binary..."
        if [ -f src/app/tor ]; then
          echo "‚úÖ Binary exists"
          file src/app/tor
          # Intentar obtener versi√≥n
          ./src/app/tor --version || echo "‚ö†Ô∏è Version check failed but binary exists"
        else
          echo "‚ùå Binary not found!"
          echo "üìÅ Listing build directory:"
          find . -name "tor" -type f
          exit 1
        fi

    - name: Prepare artifacts
      run: |
        echo "üì¶ Preparing artifacts for ${{ matrix.arch }}..."
        mkdir -p artifacts/${{ matrix.arch }}
        cp tor-src/src/app/tor artifacts/${{ matrix.arch }}/
        cd artifacts/${{ matrix.arch }}
        sha256sum tor > tor.sha256
        echo "Tor ${{ env.TOR_VERSION }} for ${{ matrix.arch }}" > README.txt
        echo "‚úÖ Artifacts prepared"

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: tor-${{ matrix.arch }}-${{ env.TOR_VERSION }}
        path: artifacts/${{ matrix.arch }}/

  create-release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/tor-')
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: downloaded-artifacts

    - name: List downloaded files
      run: |
        echo "üìÅ Downloaded artifacts:"
        find downloaded-artifacts -type f

    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name }}
        release_name: Tor ${{ env.TOR_VERSION }} for Android
        body: |
          Tor ${{ env.TOR_VERSION }} compiled for Android
          
          Architectures included:
          - arm64-v8a (modern devices)
          - armeabi-v7a (legacy devices)
          
          Built with preinstalled Android NDK on GitHub Actions
        draft: false
        prerelease: false

    - name: Upload ARM64 Binary
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: downloaded-artifacts/tor-arm64-v8a-${{ env.TOR_VERSION }}/tor
        asset_name: tor-android-arm64-v8a
        asset_content_type: application/octet-stream

    - name: Upload ARMv7 Binary
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: downloaded-artifacts/tor-armeabi-v7a-${{ env.TOR_VERSION }}/tor
        asset_name: tor-android-armeabi-v7a
        asset_content_type: application/octet-stream
