name: Build Tor for Android

on:
  workflow_dispatch:
  push:
    paths:
      - 'tor/**'
      - '.github/workflows/build-tor-android.yml'

jobs:
  build:
    runs-on: ubuntu-22.04

    strategy:
      fail-fast: false
      matrix:
        abi: [arm64-v8a, armeabi-v7a]

    steps:
      - uses: actions/checkout@v4

      - name: Setup NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r27c
          add-to-path: true

      - name: Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential autoconf automake libtool pkg-config \
            cmake ninja-build gettext git zlib1g-dev perl

      - name: Env
        run: |
          export API=21

          case "${{ matrix.abi }}" in
            arm64-v8a)
              HOST_TRIPLE="aarch64-linux-android"
              OPENSSL_TARGET="android-arm64"
              ;;
            armeabi-v7a)
              HOST_TRIPLE="armv7a-linux-androideabi"
              OPENSSL_TARGET="android-arm"
              ;;
          esac

          TOOLCHAIN="$ANDROID_NDK/toolchains/llvm/prebuilt/linux-x86_64/bin"
          BUILD_ROOT="$GITHUB_WORKSPACE/build/${{ matrix.abi }}"
          INSTALL_ROOT="$BUILD_ROOT/install"

          mkdir -p "$INSTALL_ROOT"

          echo "API=$API" >> $GITHUB_ENV
          echo "HOST_TRIPLE=$HOST_TRIPLE" >> $GITHUB_ENV
          echo "OPENSSL_TARGET=$OPENSSL_TARGET" >> $GITHUB_ENV
          echo "TOOLCHAIN=$TOOLCHAIN" >> $GITHUB_ENV
          echo "BUILD_ROOT=$BUILD_ROOT" >> $GITHUB_ENV
          echo "INSTALL_ROOT=$INSTALL_ROOT" >> $GITHUB_ENV

          echo "CC=$TOOLCHAIN/${HOST_TRIPLE}${API}-clang" >> $GITHUB_ENV
          echo "CXX=$TOOLCHAIN/${HOST_TRIPLE}${API}-clang++" >> $GITHUB_ENV
          echo "AR=$TOOLCHAIN/llvm-ar" >> $GITHUB_ENV
          echo "RANLIB=$TOOLCHAIN/llvm-ranlib" >> $GITHUB_ENV
          echo "STRIP=$TOOLCHAIN/llvm-strip" >> $GITHUB_ENV
          echo "NM=$TOOLCHAIN/llvm-nm" >> $GITHUB_ENV

          echo "CFLAGS=-fPIC -O2" >> $GITHUB_ENV
          echo "LDFLAGS=-fPIC" >> $GITHUB_ENV

      # ---------------------- OpenSSL ----------------------
      - name: Build OpenSSL
        env:
          PATH: ${{ env.TOOLCHAIN }}:/usr/bin:/bin
        run: |
          cd "$BUILD_ROOT"
          git clone https://github.com/openssl/openssl.git --depth=1 --branch=openssl-3.2 openssl
          cd openssl

          ./Configure "$OPENSSL_TARGET" no-shared no-tests --prefix="$INSTALL_ROOT/openssl"
          make -j$(nproc)
          make install_sw

      # ---------------------- libevent ----------------------
      - name: Build libevent
        run: |
          cd "$BUILD_ROOT"
          git clone https://github.com/libevent/libevent.git --depth=1 --branch=release-2.1.12-stable libevent
          cd libevent

          ./autogen.sh
          ./configure \
            --host="$HOST_TRIPLE" \
            --prefix="$INSTALL_ROOT/libevent" \
            --disable-shared \
            --enable-static \
            CFLAGS="$CFLAGS -I$INSTALL_ROOT/openssl/include" \
            LDFLAGS="$LDFLAGS -L$INSTALL_ROOT/openssl/lib"

          make -j$(nproc)
          make install

      # ------------------------ Tor -----------------------
      - name: Build Tor
        run: |
          cd "$BUILD_ROOT"
          git clone https://git.torproject.org/tor.git --depth=1 --branch=release-0.4.8 tor
          cd tor

          export PATH="$TOOLCHAIN:$PATH"
          export CC="$TOOLCHAIN/${HOST_TRIPLE}${API}-clang"
          export CXX="$TOOLCHAIN/${HOST_TRIPLE}${API}-clang++"
          export AR="$TOOLCHAIN/llvm-ar"
          export RANLIB="$TOOLCHAIN/llvm-ranlib"
          export STRIP="$TOOLCHAIN/llvm-strip"
          export NM="$TOOLCHAIN/llvm-nm"
          export TOR_CROSS_COMPILE_PREFIX="${HOST_TRIPLE}-"

          ./autogen.sh
          ./configure \
            --host="$HOST_TRIPLE" \
            --prefix="$INSTALL_ROOT/tor" \
            --disable-asciidoc \
            --enable-static-tor \
            --disable-tool-name-check \
            --with-openssl-dir="$INSTALL_ROOT/openssl" \
            --with-libevent-dir="$INSTALL_ROOT/libevent" \
            CFLAGS="$CFLAGS -I$INSTALL_ROOT/openssl/include -I$INSTALL_ROOT/libevent/include" \
            LDFLAGS="$LDFLAGS -L$INSTALL_ROOT/openssl/lib -L$INSTALL_ROOT/libevent/lib"

          make -j$(nproc)
          make install

      # ----------------------- Upload ----------------------
      - name: Upload Tor
        uses: actions/upload-artifact@v4
        with:
          name: tor-${{ matrix.abi }}
          path: ${{ env.INSTALL_ROOT }}/tor

